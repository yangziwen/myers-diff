<html>
<head>
<style>
div {
    font-size: 12px;
}
h1 {
    text-align: center;
}
.container {
    margin: 0px auto;
    width: 1180px;
}
.diff_area {
    width: 580px;
    height: 300px;
    border: 1px solid #999;
    display: inline-block;
}
.operation-container {
    margin: 10px auto;
    width: 350px;
}
.decoration-delete {
    background-color: lightcoral
}
.decoration-add {
    background-color:lightgreen
}
#search_depth_input {
    width: 60px;
}
#step_chart {
    width: 580px;
    height: 400px;
    display: inline-block;
    border: 1px solid #999;
}
.diff-result {
    display: inline-block;
}
#diff_result {
    width: 580px;
    height: 400px;
    border: 1px solid #999;
}
</style>
<script src="js/myers.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/4.1.0.rc2/echarts-en.common.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.14.3/min/vs/loader.js"></script>
<script src="js/require.js" async="true"></script>
<script>
require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.14.3/min/vs' }});
window.onload = () => {
    let srcTextArea = document.getElementById('src_txt');
    let dstTextArea = document.getElementById('dst_txt');
    let diffResult = document.getElementById('diff_result');
    let findAllStepsSel = document.getElementById('find_all_steps_sel');
    let searchDepthInput = document.getElementById('search_depth_input');
    let chart = echarts.init(document.getElementById('step_chart'));
    let editors = {diffLineNumbers: {}};
    window.editors = editors;

    require(['vs/editor/editor.main'], function() {
        editors['srcEditor'] = monaco.editor.create(srcTextArea, {
            minimap: {
                enabled: false
            }
        });
        editors['dstEditor'] = monaco.editor.create(dstTextArea, {
            minimap: {
                enabled: false
            }
        });
        editors['diffEditor'] = monaco.editor.create(diffResult, {
            lineNumbers: (originLineNumber) => editors['diffLineNumbers'][originLineNumber],
            minimap: {
                enabled: false
            }
        });
    });

    function generateHighlightDecorations(edits) {
        let lineNumber = 0;
        let decorations = [];
        for (let edit of edits) {
            if (!['delete', 'add'].includes(edit.type)) {
                lineNumber += edit.lines.length;
                continue;
            }
            decorations.push({
                range: new monaco.Range(lineNumber + 1, 1, lineNumber + edit.lines.length, 1),
                options: {
                    isWholeLine: true,
                    className: `decoration-${edit.type}`
                }
            })
            lineNumber += edit.lines.length;
        }
        return decorations;
    }

    function generateLineNumbers(edits) {
        let lineNumbers = {};
        let totalLineNumber = 0;
        let srcLineNumber = 0;
        let dstLineNumber = 0;
        for (let edit of edits) {
            for (let i = 0; i < edit.lines.length; i++) {
                totalLineNumber++;
                if (edit.type == 'delete') {
                    srcLineNumber ++;
                    lineNumbers[totalLineNumber] = srcLineNumber;
                } else if (edit.type == 'add') {
                    dstLineNumber ++;
                    lineNumbers[totalLineNumber] = '';
                } else if (edit.type == 'common') {
                    srcLineNumber ++;
                    dstLineNumber ++;
                    lineNumbers[totalLineNumber] = srcLineNumber;
                }
            }
        }
        return lineNumbers;
    }

    function refreshDiffEditor(edits, el) {
        editors['diffLineNumbers'] = generateLineNumbers(edits);
        let diffEditor = editors['diffEditor'];
        diffEditor.setValue(edits.map(edit => edit.lines).flatMap(line => line).join('\n'));
        diffEditor.deltaDecorations([], generateHighlightDecorations(edits));
    }

    document.getElementById('compare_btn').onclick = ev => {
        let srcText = editors.srcEditor.getValue();
        let dstText = editors.dstEditor.getValue();
        let findAllSteps = findAllStepsSel.value === 'true';
        let diff = new MyersDiff({
            srcArr: srcText.split(/\r|\n/),
            dstArr: dstText.split(/\r|\n/), 
            findAllSteps,
            maxSearchDepth: searchDepthInput.value
        });
        diff.calDiff();
        refreshChart(diff);
        window.diff = diff;
        refreshDiffEditor(diff.getEdits(), diffResult);
    };

    chart.on('click', params => {
        if (params.componentType == 'series') {
            let [d, k] = params.data;
            refreshDiffEditor(diff.getEdits({d, k}), diffResult);
        }
    });

    function refreshChart(diff) {
        let stepSet = new Set();
        let series = [];
        for (let finalStep of diff.getFinalSteps()) {
            let data = generateDataByLastStep(diff, finalStep, stepSet);
            if (data.length <= 1) {
                continue;
            }
            series.push({type: 'line', data});
        }
        for (let d of Object.keys(diff.prevStepMapping).reverse()) {
            for (let k of Object.keys(diff.prevStepMapping[d])) {
                let data = generateDataByLastStep(diff, {d, k}, stepSet);
                if (data.length <= 1) {
                    continue;
                }
                series.push({
                    type: 'line',
                    lineStyle: {
                        normal: {
                            type: 'dashed'
                        }
                    },
                    data
                });
            }
        }
        chart.setOption({
            title: {
                text: '',
                x: 'center'
            },
            tooltip: {
                backgroundColor: 'rgba(255, 255, 255, 0.7)',
                borderColor: '#ccc',
                borderWidth: 1,
                textStyle: {
                    color: '#666'
                },
                formatter(params) {
                    let [d, k] = params.data;
                    let pos = diff.getPosition(d, k);
                    return [
                        `pos: (x=${pos.x}, y=${pos.y})`,
                        `step: (d=${d}, k=${k})`
                    ].join('<br/>')
                }
            },
            animation: false,
            grid: {
                left: 35,
                right: 20,
                top: 20,
                bottom: 35
            },
            dataZoom: {
                type: 'inside',
                zoomOnMouseWheel: 'ctrl'
            },
            xAxis: {
                name: 'd',
                nameLocation: 'middle',
                type: 'value'
            },
            yAxis: {
                name: 'k = x - y',
                nameLocation: 'middle',
                type: 'value'
            },
            series: series
        }, true);
    }

    function generateDataByLastStep(diff, lastStep, stepSet) {
        let steps = diff.getSteps(lastStep).map(step => {
            step.key = step.d + ',' + step.k;
            return step;
        });
        let data = [];
        for (let step of steps.reverse()) {
            data.unshift([step.d, step.k]);
            if (stepSet.has(step.key)) {
                break;
            }
            stepSet.add(step.key);
        }
        return data;
    }
}
</script>
</head>
<body>
    <h1>基于Myers算法的文本比对工具</h1>
    <div class="container">
        <div id="src_txt" class="diff_area"></div>
        <div id="dst_txt" class="diff_area"></div>
    </div>
    <div class="operation-container">
        计算所有路径
        <select id="find_all_steps_sel">
            <option value="true">是</option>
            <option value="false" selected>否</option>
        </select>
        / 搜索深度
        <input id="search_depth_input" value="1000"/>
        / <button id="compare_btn">比较</button>
    </div>
    <div class="container">
        <div id="step_chart"></div>
        <div id="diff_result" class="diff-result"></div>
    </div>
</body>
</html>